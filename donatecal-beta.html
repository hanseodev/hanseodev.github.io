<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>나눔 계산기</title>
    <style>
      :root {
        --bg: #0f1115;
        --card: #171a21;
        --muted: #9097a7;
        --text: #e7ecf3;
        --accent: #7dd3fc;
        --line: #22283a;
        --good: #86efac;
        --warn: #facc15;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Pretendard,
          Apple SD Gothic Neo, Noto Sans KR, sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      header {
        position: sticky;
        top: 0;
        z-index: 10;
        backdrop-filter: saturate(1.2) blur(8px);
        background: color-mix(in lab, var(--bg), transparent 40%);
        border-bottom: 1px solid var(--line);
      }
      header .inner {
        max-width: 1100px;
        margin: 0 auto;
        padding: 14px 16px;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      h1 {
        font-size: 18px;
        margin: 0;
      }
      main {
        max-width: 1100px;
        margin: 0 auto;
        padding: 24px 16px 120px;
      }
      .grid {
        display: grid;
        gap: 16px;
      }
      @media (min-width: 920px) {
        .grid {
          grid-template-columns: 1.1fr 1fr;
        }
      }
      .card {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 16px;
      }
      .card h2 {
        font-size: 16px;
        margin: 0 0 10px;
      }
      .row {
        display: grid;
        grid-template-columns: 160px 1fr auto;
        gap: 10px;
        align-items: center;
        margin: 8px 0;
      }
      label {
        color: var(--muted);
        font-size: 14px;
      }
      input,
      select,
      textarea {
        width: 100%;
        background: #0c0f14;
        color: var(--text);
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 10px 12px;
        outline: none;
      }
      input[type="checkbox"] {
        width: auto;
      }
      textarea {
        min-height: 96px;
        resize: vertical;
      }
      .muted {
        color: var(--muted);
      }
      .help {
        font-size: 12px;
        color: var(--muted);
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        border-bottom: 1px solid var(--line);
        padding: 8px 6px;
        font-size: 14px;
      }
      th {
        color: var(--muted);
        text-align: left;
        font-weight: 600;
      }
      .stack {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .btns {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      button {
        background: #0c0f14;
        color: var(--text);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 10px 14px;
        cursor: pointer;
      }
      button.primary {
        background: linear-gradient(180deg, #1f2937, #0c111b);
        border-color: #263147;
      }
      button.accent {
        background: linear-gradient(180deg, #0ea5e9, #0284c7);
        border-color: #0369a1;
      }
      .pill {
        display: inline-block;
        padding: 2px 8px;
        border: 1px solid var(--line);
        border-radius: 999px;
        color: var(--muted);
        font-size: 12px;
      }
      .footer {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        border-top: 1px solid var(--line);
        background: color-mix(in lab, var(--bg), transparent 30%);
        backdrop-filter: saturate(1.2) blur(8px);
      }
      .footer .inner {
        max-width: 1100px;
        margin: 0 auto;
        padding: 12px 16px;
        display: flex;
        gap: 10px;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          monospace;
      }
      .right {
        margin-left: auto;
      }
      .section-title {
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: space-between;
      }
      .section-title small {
        color: var(--muted);
      }
      /* remove number spinners (Chrome/Edge/Safari) */
      input[type="number"]::-webkit-outer-spin-button,
      input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      /* remove number spinners (Firefox + modern) */
      input[type="number"] {
        -moz-appearance: textfield;
        appearance: textfield;
      }
      /* details summary emphasis */
      details > summary {
        font-weight: 700;
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 8px 10px;
        background: #0c0f14;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="inner">
        <h1>나눔 계산기</h1>
        <div id="dailyQuote" class="help right"></div>
      </div>
    </header>
    <main class="grid">
      <!-- 좌측: 입력 -->
      <section class="card">
        <div class="section-title">
          <h2>기본 정보</h2>
        </div>
        <div class="row">
          <label for="date">날짜</label>
          <input id="date" type="date" />
        </div>
        <div class="row">
          <label for="dailyNote">일일 보고</label>
          <textarea id="dailyNote" placeholder="(보고내용)"></textarea>
          <div></div>
        </div>
      </section>

      <section class="card">
        <h2>매출</h2>
        <div class="row">
          <label for="salesBakery">빵집 매출</label
          ><input
            id="salesBakery"
            type="text"
            inputmode="numeric"
            placeholder="0"
          />
        </div>
        <div class="row">
          <label for="salesSand">샌드위치 매출</label
          ><input
            id="salesSand"
            type="text"
            inputmode="numeric"
            placeholder="0"
          />
        </div>
        <div class="row">
          <label>총 매출</label
          ><input id="salesTotal" class="mono" type="text" readonly />
        </div>
      </section>

      <section class="card">
        <h2>나눔</h2>
        <table id="donTable">
          <thead>
            <tr>
              <th style="width: 40%">나눔처</th>
              <th>금액</th>
              <th style="width: 12%"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="btns" style="margin-top: 8px">
          <button id="addDonor">+ 항목 추가</button>
        </div>
        <div class="row">
          <label for="boxes">나눔 박스(1/2 적용)</label
          ><input id="boxes" type="number" step="0.5" placeholder="" />
        </div>
        <div class="row">
          <label for="yesterdayCum">어제까지 나눔 누계</label
          ><input
            id="yesterdayCum"
            type="text"
            inputmode="numeric"
            placeholder=""
          />
        </div>
        <div class="row">
          <label for="donationCum">당월 나눔 누계</label
          ><input id="donationCum" type="text" readonly />
        </div>
      </section>

      <section class="card">
        <div class="section-title">
          <h2>분류별 재고</h2>
        </div>
        <div class="row">
          <label for="catDang">단과자</label
          ><input
            id="catDang"
            type="text"
            inputmode="numeric"
            placeholder="자동계산됩니다"
            readonly
          />
        </div>
        <div class="row">
          <label for="catHealth">건강빵</label
          ><input
            id="catHealth"
            type="text"
            inputmode="numeric"
            placeholder=""
          /><label class="help"
            ><input id="catHealthSoldOut" type="checkbox" /> 매진</label
          >
        </div>
        <div class="row">
          <label for="catSand">샌드위치</label
          ><input
            id="catSand"
            type="text"
            inputmode="numeric"
            placeholder=""
          /><label class="help"
            ><input id="catSandSoldOut" type="checkbox" /> 매진</label
          >
        </div>
        <div class="stack">
          <details open>
            <summary>샌드위치 폐기 목록</summary>
            <table id="sandItems">
              <thead>
                <tr>
                  <th>제품명</th>
                  <th>수량</th>
                  <th>단가</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="btns" style="margin-top: 8px">
              <button id="addSand">+ 항목 추가</button>
            </div>
          </details>
        </div>
      </section>

      <section class="card">
        <div class="section-title">
          <h2>주요 제품 재고</h2>
          <small class="help">매진 체크 시 수량·단가는 무시</small>
        </div>
        <table id="invTable">
          <thead>
            <tr>
              <th style="width: 26%">품목</th>
              <th style="width: 18%">수량</th>
              <th style="width: 18%">단가</th>
              <th style="width: 10%">매진</th>
              <th style="width: 18%">매진 시각</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="btns" style="margin-top: 8px">
          <button id="addInv">+ 항목 추가</button>
        </div>
      </section>

      <!-- 우측: 출력 -->
      <section class="card" style="grid-column: 1/-1">
        <div class="section-title">
          <h2>보고 내용 미리보기 & 복사</h2>
          <div class="btns">
            <button id="gen" class="primary">생성</button>
            <button id="copy" class="accent">복사하기</button>
            <button id="clearAll">초기화</button>
          </div>
        </div>
        <textarea
          id="output"
          class="mono"
          style="min-height: 220px"
          placeholder="[보고 내용이 생성됩니다]"
        ></textarea>
        <div class="help" style="margin-top: 6px">
          필요 시 내용 수정 후 복사하세요.
        </div>
      </section>
    </main>

    <script>
      // ===== 유틸 =====
      const $ = (sel) => document.querySelector(sel);
      const fmt = (n) => (isFinite(n) ? n.toLocaleString("ko-KR") : "");
      const parseN = (v) => {
        const n = Number(String(v).replace(/[\,\s]/g, ""));
        return isFinite(n) ? n : 0;
      };
      const fmtWon = (n) => (isFinite(n) ? fmt(n) + "원" : "");
      const fmtWonSym = (n) => (isFinite(n) ? fmt(n) + "₩" : "");
      const pad2 = (s) => String(s).padStart(2, "0");

      // 천/백 자리 표시 (하위 4자리 기준)
      function thousandHundred(n) {
        const mod = Math.abs(n) % 10000;
        const t = Math.floor(mod / 1000); // 천의 자리
        const h = Math.floor((mod % 1000) / 100); // 백의 자리
        return `${t}천 ${h}백`;
      }
      // 억/천만/백만 자리 표시 (상위 3자릿수)
      function hundredMillionTenMillionMillion(n) {
        const a = Math.abs(Math.floor(n));
        const eok = Math.floor(a / 100000000) % 10;
        const tenM = Math.floor(a / 10000000) % 10;
        const oneM = Math.floor(a / 1000000) % 10;
        return `${eok}억 ${tenM}천 ${oneM}백`;
      }
      // 시간 정규화: 1900 -> 19:00, 930 -> 09:30
      // 입력 필드에 3자리 콤마 자동 적용 (숫자만 허용)
      function formatCommaField(el) {
        if (!el) return 0;
        // 숫자만 남기기
        const raw = (el.value || "").replace(/[^0-9]/g, "");
        if (raw === "") {
          el.value = "";
          return 0;
        }
        // 3자리 콤마 적용
        const withCommas = raw.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        // 커서 이동 이슈 최소화: 끝으로 보냄
        const selEnd = withCommas.length;
        el.value = withCommas;
        try {
          el.setSelectionRange(selEnd, selEnd);
        } catch (_) {}
        return parseN(withCommas);
      }
      function normTime(val) {
        if (!val) return "";
        let s = String(val).trim();
        if (s.includes(":")) {
          const [h, m = "00"] = s.split(":");
          return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}`;
        }
        const d = s.replace(/[^0-9]/g, "");
        if (d.length === 4) return `${d.slice(0, 2)}:${d.slice(2)}`;
        if (d.length === 3) return `0${d[0]}:${d.slice(1)}`;
        if (d.length <= 2) return `${String(d).padStart(2, "0")}:00`;
        return s;
      }

      // 고정 품목 집합 및 단과자 자동계산
      const FIXED_NAMES = new Set([
        "튀소",
        "구마",
        "부추",
        "초코",
        "크리미",
        "말차튀소",
      ]);

      function fixedItemsTotal() {
        return (state.invItems || []).reduce((sum, it) => {
          if (FIXED_NAMES.has(it.name) && !it.soldOut) {
            const q = parseN(it.qty);
            const p = parseN(it.price);
            return sum + q * p;
          }
          return sum;
        }, 0);
      }

      function updateCatDang() {
        const donations = donationsSum(); // 모든 나눔처 금액 합
        const fixedSum = fixedItemsTotal(); // 튀소~말차튀소 합(매진 제외)
        const health = parseN(document.querySelector("#catHealth").value);
        const val = donations - fixedSum - health;
        state.catDang = val > 0 ? val : 0;
        const el = document.querySelector("#catDang");
        if (el) el.value = state.catDang ? fmt(state.catDang) : "";
      }

      // ===== Daily Quote (consistent per date) =====
      const QUOTES = [
        {
          text: "성공은 작은 노력을 꾸준히 쌓은 결과다.",
          author: "로버트 콜리어",
        },
        { text: "천 리 길도 한 걸음부터 시작된다.", author: "중국 속담" },
        {
          text: "우리가 반복해서 하는 것이 곧 우리다.",
          author: "아리스토텔레스",
        },
        { text: "노력은 절대 배신하지 않는다.", author: "손흥민" },
        {
          text: "꾸준함은 천천히가 아니라 멈추지 않는 것이다.",
          author: "콘라드 힐튼",
        },
        {
          text: "잔잔한 물결도 오래 흐르면 바위를 뚫는다.",
          author: "한국 속담",
        },
        { text: "성실함은 모든 덕의 기초다.", author: "벤저민 프랭클린" },
        { text: "포기하지 않는 사람이 결국 해낸다.", author: "테드 터너" },
        { text: "작은 습관이 큰 미래를 만든다.", author: "잭 캔필드" },
        { text: "꾸준하면 못 오를 산이 없다.", author: "몽골 속담" },
        { text: "강한 사람보다 꾸준한 사람이 이긴다.", author: "핀란드 속담" },
        {
          text: "오늘의 성실함이 내일의 기회를 만든다.",
          author: "오프라 윈프리",
        },
        {
          text: "천재란 오랫동안 인내한 사람일 뿐이다.",
          author: "토머스 카라일",
        },
        { text: "습관은 두 번째 천성이다.", author: "로마 격언" },
        { text: "계속 걷는다면 결국 목적지에 닿는다.", author: "영국 속담" },
        {
          text: "나는 재능보다 연습이 나를 만들었다고 믿는다.",
          author: "안네트 켈러만",
        },
        {
          text: "비가 와도 멈추지 않는 강은 끝내 바다에 다다른다.",
          author: "스페인 속담",
        },
        { text: "성공은 준비된 사람을 좋아한다.", author: "루이스 파스퇴르" },
        { text: "성실한 하루가 성실한 인생을 만든다.", author: "괴테" },
        { text: "꾸준한 발걸음은 결국 산을 넘는다.", author: "일본 속담" },
        {
          text: "나는 매일 조금씩 나아지려고 노력했다.",
          author: "마이클 조던",
        },
        { text: "뿌린 대로 거둔다.", author: "성경 격언" },
        {
          text: "한 번의 큰 도약보다 천 번의 작은 걸음이 더 멀리 간다.",
          author: "노르웨이 속담",
        },
        {
          text: "작은 발전도 멈추지 않으면 큰 성과가 된다.",
          author: "조지 매튜스 애덤스",
        },
        { text: "반복은 능력을 만든다.", author: "라틴 격언" },
        { text: "좋은 습관은 성공을 부른다.", author: "스티븐 코비" },
        {
          text: "천천히 가더라도 뒤로만 가지 않으면 된다.",
          author: "러시아 속담",
        },
        { text: "성실함은 가장 강력한 무기다.", author: "사무엘 스마일스" },
        {
          text: "꾸준한 준비가 기적 같은 순간을 만든다.",
          author: "무하마드 알리",
        },
        { text: "계속하면 이룬다.", author: "라틴 격언" },
      ];
      function quoteIndexFromDate(dateStr) {
        // simple deterministic hash by date string (YYYY-MM-DD)
        let h = 0;
        for (let i = 0; i < dateStr.length; i++) {
          h = (h * 31 + dateStr.charCodeAt(i)) >>> 0;
        }
        return h % QUOTES.length;
      }
      function setDailyQuote() {
        const el = document.getElementById("dailyQuote");
        if (!el) return;
        const dStr = state.date || todayKST();
        const pick = QUOTES[quoteIndexFromDate(dStr)];
        el.textContent = `“${pick.text}” — ${pick.author}`;
      }

      // ===== 초기 데이터 =====
      const defaultState = {
        date: "",
        dailyNote: "",
        salesBakery: 0,
        salesSand: 0,
        boxes: 0,
        donations: [
          { name: "나눔처 A", amount: 0, fixed: true },
          { name: "나눔처 B", amount: 0, fixed: true },
          { name: "나눔처 C", amount: 0, fixed: true },
        ],
        yesterdayCum: 0,
        donationCum: 0,
        catDang: 0,
        catHealth: 0,
        catHealthSoldOut: false,
        catSand: 0,
        catSandSoldOut: false,
        sandItems: [{ name: "", qty: 0, price: 0 }],
        invItems: [
          {
            name: "튀소",
            qty: 0,
            price: 0,
            soldOut: false,
            time: "",
            fixed: true,
          },
          {
            name: "구마",
            qty: 0,
            price: 0,
            soldOut: false,
            time: "",
            fixed: true,
          },
          {
            name: "부추",
            qty: 0,
            price: 0,
            soldOut: false,
            time: "",
            fixed: true,
          },
          {
            name: "초코",
            qty: 0,
            price: 0,
            soldOut: false,
            time: "",
            fixed: true,
          },
          {
            name: "크리미",
            qty: 0,
            price: 0,
            soldOut: false,
            time: "",
            fixed: true,
          },
          {
            name: "말차튀소",
            qty: 0,
            price: 0,
            soldOut: false,
            time: "",
            fixed: true,
          },
          { name: "", qty: 0, price: 0, soldOut: false, time: "" },
        ],
      };

      const KEY = "closing_report_v1";

      function loadState() {
        try {
          const raw = localStorage.getItem(KEY);
          if (!raw) return structuredClone(defaultState);
          const obj = JSON.parse(raw);
          return { ...structuredClone(defaultState), ...obj };
        } catch (e) {
          return structuredClone(defaultState);
        }
      }
      function saveState() {
        localStorage.setItem(KEY, JSON.stringify(state));
      }

      let state = loadState();

      // ===== 폼 바인딩 =====
      function todayKST() {
        const t = new Date();
        t.setHours(t.getHours() + 9);
        return t.toISOString().slice(0, 10);
      }
      function bindBasic() {
        const dateEl = document.querySelector("#date");
        if (dateEl) dateEl.value = state.date || todayKST();
        setDailyQuote();
        const dnEl = document.querySelector("#dailyNote");
        if (dnEl) dnEl.value = state.dailyNote;

        const sbEl = document.querySelector("#salesBakery");
        if (sbEl) sbEl.value = state.salesBakery ? fmt(state.salesBakery) : "";
        const ssEl = document.querySelector("#salesSand");
        if (ssEl) ssEl.value = state.salesSand ? fmt(state.salesSand) : "";

        const bxEl = document.querySelector("#boxes");
        if (bxEl) bxEl.value = state.boxes || "";
        const ycEl0 = document.querySelector("#yesterdayCum");
        if (ycEl0)
          ycEl0.value = state.yesterdayCum ? fmt(state.yesterdayCum) : "";
        const dcEl = document.querySelector("#donationCum");
        if (dcEl) dcEl.value = state.donationCum || "";

        const cdEl = document.querySelector("#catDang");
        if (cdEl) cdEl.value = state.catDang ? fmt(state.catDang) : "";
        const chEl0 = document.querySelector("#catHealth");
        if (chEl0) chEl0.value = state.catHealth ? fmt(state.catHealth) : "";
        const csEl0 = document.querySelector("#catSand");
        if (csEl0) csEl0.value = state.catSand ? fmt(state.catSand) : "";

        const chsEl = document.querySelector("#catHealthSoldOut");
        if (chsEl) chsEl.checked = !!state.catHealthSoldOut;
        const cssEl = document.querySelector("#catSandSoldOut");
        if (cssEl) cssEl.checked = !!state.catSandSoldOut;

        renderDonations();
        calcTotals();
        updateCatDang();
        syncCategoryDisabled();
        calcTotals();
        ["yesterdayCum", "catHealth", "catSand"].forEach((id) => {
          const el = document.querySelector("#" + id);
          if (el && el.value) el.value = fmt(parseN(el.value));
        });
      }

      function onInputSync() {
        $("#date").addEventListener("input", (e) => {
          state.date = e.target.value;
          saveState();
          setDailyQuote();
        });
        $("#dailyNote").addEventListener("input", (e) => {
          state.dailyNote = e.target.value;
          saveState();
        });

        ["salesBakery", "salesSand"].forEach((id) => {
          const el = document.querySelector("#" + id);
          if (!el) return;

          const reformat = () => {
            const val = formatCommaField(el); // 숫자만 남기고 3자리 콤마
            state[id] = val;
            calcTotals(); // 총합 즉시 갱신
            saveState();
          };

          el.addEventListener("input", reformat);
          el.addEventListener("keyup", (e) => {
            if (e.key !== "Tab") reformat();
          });
          el.addEventListener("paste", () => {
            setTimeout(reformat, 0);
          });
          el.addEventListener("blur", () => {
            el.value = state[id] ? fmt(state[id]) : "";
          });

          // 페이지 로드 후 값이 있으면 한 번 정규화
          if (el.value) {
            reformat();
          }
        });

        // 기존: boxes, yesterdayCum, donationCum, catDang, catHealth, catSand
        // => boxes, donationCum: 그대로, catDang/Health/Sand/yesterdayCum: custom listeners below
        ["boxes", "donationCum"].forEach((id) => {
          $("#" + id).addEventListener("input", (e) => {
            state[id] = parseN(e.target.value);
            saveState();
          });
        });

        ["catHealth", "catSand"].forEach((id) => {
          // ← catDang 제외
          const el = document.querySelector("#" + id);
          if (!el) return;
          el.addEventListener("input", () => {
            state[id] = formatCommaField(el);
            saveState();
            if (id === "catHealth") updateCatDang(); // ← 건강빵 바뀌면 단과자 재계산
          });
          el.addEventListener("blur", () => {
            el.value = state[id] ? fmt(state[id]) : "";
          });
        });
        const ycEl = document.querySelector("#yesterdayCum");
        if (ycEl) {
          ycEl.addEventListener("input", () => {
            state.yesterdayCum = formatCommaField(ycEl);
            updateDonationCum();
            saveState();
          });
          ycEl.addEventListener("blur", () => {
            ycEl.value = state.yesterdayCum ? fmt(state.yesterdayCum) : "";
          });
        }

        const hso = document.querySelector("#catHealthSoldOut");
        if (hso) {
          hso.addEventListener("change", (e) => {
            state.catHealthSoldOut = e.target.checked;
            saveState();
            syncCategoryDisabled();
          });
        }
        const sso = document.querySelector("#catSandSoldOut");
        if (sso) {
          sso.addEventListener("change", (e) => {
            state.catSandSoldOut = e.target.checked;
            saveState();
            syncCategoryDisabled();
          });
        }
      }

      function calcTotals() {
        const bEl = document.querySelector("#salesBakery");
        const sEl = document.querySelector("#salesSand");
        const tEl = document.querySelector("#salesTotal");
        const br = document.querySelector("#salesBreak");

        const b = parseN(bEl && bEl.value);
        const s = parseN(sEl && sEl.value);
        const total = b + s;
        state.salesTotal = total;

        if (tEl) tEl.value = fmt(total);
        if (br) br.textContent = `(${hundredMillionTenMillionMillion(total)})`;
      }
      // 카테고리 입력 비/활성 연동
      function syncCategoryDisabled() {
        const healthEl = document.querySelector("#catHealth");
        const healthSo = document.querySelector("#catHealthSoldOut");
        if (healthEl && healthSo) {
          if (healthSo.checked) {
            if (!healthEl.dataset.prev) healthEl.dataset.prev = healthEl.value;
            healthEl.value = "";
            healthEl.disabled = true;
          } else {
            healthEl.disabled = false;
            if (healthEl.dataset.prev && !healthEl.value) {
              healthEl.value = healthEl.dataset.prev;
            }
          }
        }
        const sandEl = document.querySelector("#catSand");
        const sandSo = document.querySelector("#catSandSoldOut");
        if (sandEl && sandSo) {
          if (sandSo.checked) {
            if (!sandEl.dataset.prev) sandEl.dataset.prev = sandEl.value;
            sandEl.value = "";
            sandEl.disabled = true;
          } else {
            sandEl.disabled = false;
            if (sandEl.dataset.prev && !sandEl.value) {
              sandEl.value = sandEl.dataset.prev;
            }
          }
        }
      }

      // ===== 동적 테이블: 샌드위치 세부 =====
      const sandBody = document.querySelector("#sandItems tbody");
      function renderSand() {
        if (!sandBody) return;

        // ✅ sandItems이 비어 있으면 기본 1행 자동 생성
        if (!state.sandItems || state.sandItems.length === 0) {
          state.sandItems = [{ name: "", qty: 0, price: 0 }];
        }

        sandBody.innerHTML = "";
        state.sandItems.forEach((it, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><input data-idx="${idx}" data-k="name" value="${
            it.name
          }" placeholder="제품명"/></td>
            <td><input type="number" min="0" step="1" data-idx="${idx}" data-k="qty" value="${
            it.qty || ""
          }"/></td>
            <td><input type="number" min="0" step="100" data-idx="${idx}" data-k="price" value="${
            it.price || ""
          }"/></td>
            <td><button data-idx="${idx}" class="delSand">삭제</button></td>`;
          sandBody.appendChild(tr);
        });
      }
      sandBody.addEventListener("input", (e) => {
        const idx = e.target.getAttribute("data-idx");
        const k = e.target.getAttribute("data-k");
        if (idx == null || !k) return;
        const v = k === "name" ? e.target.value : parseN(e.target.value);
        state.sandItems[idx][k] = v;
        saveState();
      });
      sandBody.addEventListener("click", (e) => {
        if (e.target.classList.contains("delSand")) {
          const idx = Number(e.target.getAttribute("data-idx"));
          state.sandItems.splice(idx, 1);
          renderSand();
          saveState();
        }
      });
      $("#addSand").addEventListener("click", () => {
        state.sandItems.push({ name: "", qty: 0, price: 0 });
        renderSand();
        saveState();
      });

      // ===== 나눔처(고정 A–C + 순차 추가) =====
      const donBody = document.querySelector("#donTable tbody");
      function donorNameFromIndex(i) {
        return `나눔처 ${String.fromCharCode(65 + i)}`;
      }
      function ensureFixedABC() {
        const names = state.donations?.map((d) => d.name) || [];
        if (!state.donations) {
          state.donations = [];
        }
        ["나눔처 A", "나눔처 B", "나눔처 C"].forEach((nm, i) => {
          const idx = names.indexOf(nm);
          if (idx === -1)
            state.donations.splice(i, 0, { name: nm, amount: 0, fixed: true });
          else state.donations[idx].fixed = true;
        });
      }

      // ==== Migration to fix disabled/empty lists from old localStorage ====
      function migrateState() {
        // Donations: ensure A–C exist and remain editable for amounts
        if (!Array.isArray(state.donations)) state.donations = [];
        ensureFixedABC();

        // Inventory: ensure six fixed items exist and are NOT soldOut by default
        const FIX = ["튀소", "구마", "부추", "초코", "크리미", "말차튀소"];
        if (!Array.isArray(state.invItems)) state.invItems = [];
        FIX.forEach((nm) => {
          let item = state.invItems.find((it) => it.name === nm);
          if (!item) {
            state.invItems.push({
              name: nm,
              qty: 0,
              price: 0,
              soldOut: false,
              time: "",
              fixed: true,
            });
          } else {
            item.fixed = true;
            if (item.soldOut === true) item.soldOut = false; // re-enable qty/price inputs
          }
        });
      }
      function nextDonor() {
        const base = state.donations?.length
          ? Math.max(3, state.donations.length)
          : 3;
        const name = donorNameFromIndex(base);
        return { name, amount: 0, fixed: false };
      }
      function renderDonations() {
        ensureFixedABC();
        donBody.innerHTML = "";
        state.donations.forEach((it, idx) => {
          const isFixed = !!it.fixed;
          const tr = document.createElement("tr");
          tr.innerHTML = `
                  <td><input data-idx="${idx}" data-k="name" value="${
            it.name
          }" ${isFixed ? "disabled" : ""}/></td>
                  <td><input type="text" inputmode="numeric" data-idx="${idx}" data-k="amount" value="${
            it.amount > 0 ? fmt(it.amount) : ""
          }"/></td>
                  <td>${
                    isFixed
                      ? ""
                      : `<button data-idx="${idx}" class="delDon">삭제</button>`
                  }</td>`;
          donBody.appendChild(tr);
        });
        updateDonationCum();
      }
      donBody.addEventListener("input", (e) => {
        const idx = e.target.getAttribute("data-idx");
        const k = e.target.getAttribute("data-k");
        if (idx == null || !k) return;
        let v;
        if (k === "name") {
          v = e.target.value;
        } else if (k === "amount") {
          v = formatCommaField(e.target);
        } else {
          v = parseN(e.target.value);
        }
        state.donations[idx][k] = v;
        saveState();
        updateDonationCum();
        updateCatDang();
      });
      donBody.addEventListener("click", (e) => {
        if (e.target.classList.contains("delDon")) {
          const i = Number(e.target.getAttribute("data-idx"));
          state.donations.splice(i, 1);
          renderDonations();
          saveState();
        }
      });
      document.addEventListener("click", (e) => {
        if (e.target.id === "addDonor") {
          state.donations.push(nextDonor());
          renderDonations();
          saveState();
        }
      });
      function donationsSum() {
        return (state.donations || []).reduce(
          (acc, d) => acc + parseN(d.amount),
          0
        );
      }
      function updateDonationCum() {
        const sum = donationsSum();
        const y = parseN($("#yesterdayCum").value);
        $("#donationCum").value = fmt(sum + y);
      }
      // (listener moved to onInputSync)

      // ===== 동적 테이블: 재고 =====
      const invBody = document.querySelector("#invTable tbody");
      function renderInv() {
        invBody.innerHTML = "";
        state.invItems.forEach((it, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
        <td>  <input data-idx="${idx}" data-k="name" value="${it.name}" ${
            it.fixed ? "disabled" : ""
          }/>
      </td>
        <td><input type="number" min="0" step="1" data-idx="${idx}" data-k="qty" value="${
            it.qty || ""
          }" ${it.soldOut ? "disabled" : ""}/></td>
        <td><input type="number" min="0" step="100" data-idx="${idx}" data-k="price" value="${
            it.price || ""
          }" ${it.soldOut ? "disabled" : ""}/></td>
        <td style="text-align:center"><input type="checkbox" data-idx="${idx}" data-k="soldOut" ${
            it.soldOut ? "checked" : ""
          }/></td>
        <td><input data-idx="${idx}" data-k="time" placeholder="HHMM" value="${
            it.time || ""
          }"/></td>
      `;
          invBody.appendChild(tr);
        });
      }
      invBody.addEventListener("input", (e) => {
        const idx = e.target.getAttribute("data-idx");
        const k = e.target.getAttribute("data-k");
        if (idx == null || !k) return;

        const item = state.invItems[Number(idx)];
        if (k === "name" && item && item.fixed) return; // 고정품목 이름 변경 차단

        let v;
        if (k === "soldOut") v = e.target.checked;
        else if (k === "name") v = e.target.value;
        else if (k === "time") v = normTime(e.target.value);
        else v = parseN(e.target.value);

        state.invItems[idx][k] = v;
        if (k === "soldOut") renderInv();
        saveState();
        updateCatDang();
      });
      document.addEventListener("click", (e) => {
        if (e.target.id === "addInv") {
          state.invItems.push({
            name: "",
            qty: 0,
            price: 0,
            soldOut: false,
            time: "",
          });
          renderInv();
          saveState();
        }
      });

      // ===== 보고서 생성 =====
      function buildReport() {
        const d = $("#date").value || "";
        const total = state.salesTotal || 0;
        const b = parseN($("#salesBakery").value),
          s = parseN($("#salesSand").value);
        const dFmt = (() => {
          if (!d) return "";
          const [yy, mm, dd] = d.split("-");
          return `${yy}년 ${mm}월 ${dd}일`;
        })();
        const boxesRaw = parseFloat($("#boxes").value);
        const halfBoxes = Number.isFinite(boxesRaw)
          ? Math.round((boxesRaw / 2) * 100) / 100
          : "-";
        const donSum = donationsSum();
        const ycum = parseN($("#yesterdayCum").value);
        const cumTotal = donSum + ycum;

        const catDang = parseN($("#catDang").value);
        const catHealth = parseN($("#catHealth").value);
        const soHealth = $("#catHealthSoldOut").checked;
        const catSand = parseN($("#catSand").value);
        const soSand = $("#catSandSoldOut").checked;

        const sandLines = (state.sandItems || [])
          .filter(
            (x) =>
              (x.name || "").trim() &&
              (parseN(x.qty) > 0 || parseN(x.price) > 0)
          )
          .map((x) => {
            const q = parseN(x.qty),
              p = parseN(x.price),
              total = q * p;
            const parts = [`    - ${x.name}`];
            if (q > 0) parts.push(` ${fmt(q)}`);
            if (total > 0) parts.push(` (${fmt(total)}₩)`);
            return parts.join("");
          })
          .join("\n");

        const invLines = (state.invItems || [])
          .filter((x) => (x.name || "").trim())
          .map((x) =>
            x.soldOut
              ? `- ${x.name}: 매진${
                  normTime(x.time) ? ` (${normTime(x.time)})` : ""
                }`
              : (() => {
                  const q = parseN(x.qty),
                    p = parseN(x.price),
                    total = q * p;
                  return `- ${x.name}: ${fmt(q)} (${fmt(total)}₩)`;
                })()
          )
          .join("\n");

        const lines = [
          `${dFmt} 마감입니다`,
          "",
          `\n총 매출: ${fmt(total)} (${hundredMillionTenMillionMillion(
            total
          )})`,
          `- 빵집: ${fmt(b)}`,
          `- 샌드위치: ${fmt(s)}`,
          "",
          `\n나눔빵: ${donSum ? fmt(donSum) : "-"} (${
            halfBoxes === "-" ? "-" : halfBoxes
          } BOX)`,
          `- 이번달 나눔 누계: ${cumTotal ? fmt(cumTotal) : "-"}`,
          "",
          `\n- 단과자: ${catDang ? fmt(catDang) : "-"}`,
          `- 건강빵: ${soHealth ? "매진" : catHealth ? fmt(catHealth) : "-"}`,
          `- 샌드위치: ${soSand ? "매진" : catSand ? fmt(catSand) : "-"}`,
          sandLines ? sandLines : "",
          "",
          "\n주요제품 재고",
          invLines ? invLines : "",
          "",
          "\n일일 보고",
          $("#dailyNote").value || "(보고내용)",
        ]
          .filter(Boolean)
          .join("\n");

        $("#output").value = lines;
      }

      // ===== 이벤트 =====
      $("#gen").addEventListener("click", buildReport);
      $("#copy").addEventListener("click", async () => {
        const txt = $("#output").value;
        if (!txt) return;
        try {
          await navigator.clipboard.writeText(txt);
          $("#copy").textContent = "복사됨 ✔";
          setTimeout(() => ($("#copy").textContent = "복사하기"), 1200);
        } catch (e) {
          // fallback
          $("#output").select();
          document.execCommand("copy");
          $("#copy").textContent = "복사됨 ✔";
          setTimeout(() => ($("#copy").textContent = "복사하기"), 1200);
        }
      });
      $("#clearAll").addEventListener("click", () => {
        if (!confirm("모든 입력을 초기화할까요? 저장된 값도 삭제됩니다."))
          return;
        localStorage.removeItem(KEY);
        state = structuredClone(defaultState);
        bindBasic();
        renderSand();
        renderInv();
        $("#output").value = "";
      });

      // ===== 부팅 =====
      migrateState();
      bindBasic();
      renderSand();
      renderInv();
      renderDonations();
      updateCatDang();
      buildReport();
      onInputSync();
      setDailyQuote();

      // ===== simple tests =====
      console.assert(
        hundredMillionTenMillionMillion(123456789) === "1억 2천 3백",
        "HMTMM format failed"
      );
      console.assert(
        normTime("1900") === "19:00" &&
          normTime("930") === "09:30" &&
          normTime("9") === "09:00",
        "normTime failed"
      );
    </script>
  </body>
</html>
